{% extends "network/layout.html" %} {% block body %}
<div class="container mt-4">
  {% if messages %}
    <div class="alert alert-danger">
        {% for message in messages %}
            <p>{{ message }}</p>
        {% endfor %}
    </div>
{% endif %}
  <h1 class="mb-4">All Posts</h1>

  {% for post in posts %}
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <a
          href="{% url 'perfil_Users' nome_id=post.autor.id %}"
          class="h5 text-decoration-none text-primary"
        >
          <strong>@{{ post.autor.username }}</strong>
        </a>
        <p class="text-muted mb-0">{{ post.data_criacao }}</p>
      </div>
      <p class="mb-3">{{ post.conteudo }}</p>

      <!-- Bot√£o de Like (agora funciona sem recarregar a p√°gina) -->
      <button 
      class="btn {% if user in post.curtidas.all %}btn-danger{% else %}btn-primary{% endif %} like-button" 
      data-post-id="{{ post.id }}" 
      onclick="toggleLike(this)"
    >
      üëç <span class="like-count">{{ post.curtidas.count }}</span>
    </button>
        {% if post.autor.username == user.username %}
        <a href="{% url 'edit_post' post_id=post.id %}" class="btn btn-primary">
          Edit
        </a>
        {% endif %}
      </form>
    </div>
  </div>
  {% empty %}
  <p>We are out of posts.</p>
  {% endfor %}
  <nav aria-label="Page navigation">
    <ul class="pagination">
      <!-- Bot√£o "Previous" -->
      {% if posts.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ posts.previous_page_number }}"
          >Previous</a
        >
      </li>
      {% else %}
      <li class="page-item disabled">
        <a class="page-link" href="#" tabindex="-1">Previous</a>
      </li>
      {% endif %}

      <!-- N√∫meros das p√°ginas -->
      {% for num in posts.paginator.page_range %} {% if posts.number == num %}
      <li class="page-item active">
        <a class="page-link" href="#">
          {{ num }} <span class="sr-only">(current)</span></a
        >
      </li>
      {% else %}
      <li class="page-item">
        <a class="page-link" href="?page={{ num }}">{{ num }}</a>
      </li>
      {% endif %} {% endfor %}

      <!-- Bot√£o "Next" -->
      {% if posts.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ posts.next_page_number }}">Next</a>
      </li>
      {% else %}
      <li class="page-item disabled">
        <a class="page-link" href="#" tabindex="-1">Next</a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>
<!-- Script para Curtidas Ass√≠ncronas -->
<script>
  async function toggleLike(button) {
      const postId = button.getAttribute("data-post-id");
      const likeCountSpan = button.querySelector(".like-count");
  
      const response = await fetch("{% url 'like_post' %}", {
          method: "POST",
          headers: {
              "X-CSRFToken": "{{ csrf_token }}",
              "Content-Type": "application/x-www-form-urlencoded"
          },
          body: `post_id=${postId}`
      });
  
      const data = await response.json();
  
      if (response.ok) {
          likeCountSpan.textContent = data.like_count;
          button.classList.toggle("btn-success", data.liked);
          button.classList.toggle("btn-primary", !data.liked);
      } else {
          alert("Erro ao curtir/descurtir.");
      }
  }
  </script>
  
{% endblock %}
